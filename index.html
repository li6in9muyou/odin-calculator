<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>calculator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-size: 20px;
        font-family: monospace;
      }

      body {
        padding: 3rem;
        background-color: dimgray;
      }

      #keypad {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(5, auto);
        column-gap: 0.5rem;
        row-gap: 0.5rem;
        min-width: fit-content;
      }

      #numberKeyboard {
        grid-column: 1 / span 3;
        grid-row: 2 / span 4;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        column-gap: 0.5rem;
        row-gap: 0.5rem;
      }

      button {
        aspect-ratio: 1;
        background-color: slategray;
        box-shadow: black 8px 8px 0 0;
        transform: translate(-5px, -5px);
        border: solid black 2px;
        cursor: pointer;
        color: whitesmoke;
        font-size: 15vw;
      }

      button:active {
        transform: none;
        box-shadow: none;
      }

      button[data-disabled] {
        transform: none;
        box-shadow: none;
        cursor: not-allowed;
        background-image: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 35px,
          rgba(255, 255, 255, 0.5) 35px,
          rgba(255, 255, 255, 0.5) 70px
        );
      }

      #zero {
        grid-column: 1 / span 2;
        aspect-ratio: auto;
      }

      #plus {
        grid-column: 4;
        grid-row: 2 / span 2;
        aspect-ratio: auto;
      }

      #equals {
        grid-column: 4;
        grid-row: 4 / span 2;
        aspect-ratio: auto;
      }

      #display {
        display: flex;
        flex-direction: column;
        row-gap: 1rem;
        background-color: lightgreen;
        padding: 0.5rem;
        margin-bottom: 1rem;
        min-width: fit-content;
      }

      #display > * {
        text-align: end;
      }

      #small {
        font-size: 4rem;
        min-height: 4rem;
      }

      #big {
        font-size: 8rem;
        min-height: 8rem;
      }

      #display {
        box-shadow: black 8px 8px 0 0 inset;
        transform: translate(-5px, -5px);
      }

      #command {
        margin-bottom: 1rem;
        display: flex;
        column-gap: 0.3rem;
        justify-content: end;
      }

      #command > button {
        padding: 0.4rem 2rem;
        text-transform: uppercase;
        background-color: lightsalmon;
        aspect-ratio: unset;
        font-style: italic;
        font-size: 3rem;
        color: darkblue;
      }
    </style>
  </head>
  <body>
    <div id="calculator">
      <div id="display">
        <div data-operatorDisplay></div>
        <div id="small" data-displaySmall></div>
        <div id="big" data-displayBig></div>
      </div>
      <div id="command">
        <button data-literal="$" data-command>clear</button>
      </div>
      <div id="keypad">
        <button data-disabled data-command data-literal="<">&leftarrow;</button>
        <button data-literal="d" data-operator>&divide;</button>
        <button data-literal="m" data-operator>&times;</button>
        <button data-literal="s" data-operator>&minus;</button>
        <div id="numberKeyboard">
          <button data-literal="1" data-number>1</button>
          <button data-literal="2" data-number>2</button>
          <button data-literal="3" data-number>3</button>
          <button data-literal="4" data-number>4</button>
          <button data-literal="5" data-number>5</button>
          <button data-literal="6" data-number>6</button>
          <button data-literal="7" data-number>7</button>
          <button data-literal="8" data-number>8</button>
          <button data-literal="9" data-number>9</button>
          <button id="zero" data-literal="0" data-number>0</button>
          <button data-disabled data-number>&dot;</button>
        </div>
        <button id="plus" data-literal="a" data-operator>&plus;</button>
        <button id="equals" data-literal="=" data-command>&equals;</button>
      </div>
    </div>
  </body>
  <script type="module">
    import { testcases, PerformCalculationService } from "./main.js";

    //adapters.gui
    class GraphicAdapter {
      constructor(service) {
        document
          .querySelectorAll(":not([data-disabled])[data-number]")
          .forEach((k) => {
            k.addEventListener("contextmenu", (e) => e.preventDefault());
            k.addEventListener("click", () => {
              for (const c of k.getAttribute("data-literal")) {
                service.appendToCurrentOperand(c);
              }
            });
          });

        document
          .querySelectorAll(":not([data-disabled])[data-operator]")
          .forEach((k) => {
            k.addEventListener("contextmenu", (e) => e.preventDefault());
            k.addEventListener("click", () => {
              service.setCurrentOperator(k.getAttribute("data-literal"));
            });
          });

        document
          .querySelectorAll(":not([data-disabled])[data-command]")
          .forEach((k) => {
            k.addEventListener("contextmenu", (e) => e.preventDefault());
            k.addEventListener("click", (e) => {
              const key = e.target;
              const c = key.getAttribute("data-literal");
              switch (c) {
                case "$": {
                  service.onCommand(service.commands.CLEAR);
                  break;
                }
                case "=": {
                  service.onCommand(service.commands.EVAL);
                  break;
                }
                default: {
                  console.error(`Unsupported command: ${c}`);
                }
              }
            });
          });
      }
    }

    //port.out.gui
    class DisplayPort {
      bigDisplay = document.querySelector("[data-displayBig]");
      smallDisplay = document.querySelector("[data-displaySmall]");
      operatorDisplay = document.querySelector("[data-operatorDisplay]");

      constructor() {
        this.bigDisplay.insertAdjacentText("afterbegin", "");
        this.smallDisplay.insertAdjacentText("afterbegin", "");
        this.operatorDisplay.insertAdjacentText("afterbegin", "");
      }

      setPrevOperand(text) {
        this.smallDisplay.firstChild.textContent = text;
      }

      setCurrOperator(text) {
        this.operatorDisplay.firstChild.textContent = text;
      }

      setCurrOperand(text) {
        this.bigDisplay.firstChild.textContent = text;
      }
    }

    const service = new PerformCalculationService(new DisplayPort());
    const gui = new GraphicAdapter(service);

    //tests
    class GuiTestAdapter {
      constructor(service, tests) {
        for (const test of tests) {
          for (const ch of test) {
            const key = document.querySelector(`[data-literal='${ch}']`);
            if (key !== null) {
              key.click();
            } else {
              throw `Literal "${ch}" is not supported in this adapter`;
            }
          }
        }
      }
    }

    new GuiTestAdapter(service, testcases);
  </script>
</html>
